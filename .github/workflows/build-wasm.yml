# Build MLS WASM when Rust/source changes. Commits updated pkg/ so Cloudflare Pages
# can build without Rust. Runs on push to main and when client or wasm code changes.
name: Build WASM and client

on:
  push:
    branches: [main]
    paths:
      - 'client/src/mls/wasm/**'
      - 'client/package.json'
      - 'client/package-lock.json'
      - '.github/workflows/build-wasm.yml'
  workflow_dispatch:

jobs:
  build-wasm:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: cargo install wasm-pack --locked

      - name: Build WASM
        run: |
          cd client/src/mls/wasm
          wasm-pack build --target web

      - name: Check for pkg changes
        id: pkg-diff
        run: |
          if ! git diff --quiet client/src/mls/wasm/pkg; then
            echo "changed=1" >> "$GITHUB_OUTPUT"
            git diff --stat client/src/mls/wasm/pkg
          fi

      - name: Commit and push updated pkg
        if: steps.pkg-diff.outputs.changed == '1'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add client/src/mls/wasm/pkg
          git commit -m "ci: update WASM pkg (build-wasm)"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-client:
    runs-on: ubuntu-latest
    needs: build-wasm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install and build client
        run: |
          cd client
          npm ci
          npm run build
